{%- liquid
  assign section_st = section.settings
  assign section_width = section_st.section_width
  assign color_scheme = section_st.color_scheme
  if section_st.reset_spacing
    assign reset_spacing = ' remove_spacing'
  endif
  assign column_gap = section_st.column_gap
  assign items_per_row = section_st.items_per_row
  assign items_to_show = section_st.items_to_show
  assign heading = section_st.heading
  assign description = section_st.description
  assign header_size = ''
  if section_st.header_size == 'small'
    assign header_size = 'h3'
  elsif section_st.header_size == 'large'
    assign header_size = 'h1-size'
  endif
  if section_st.items_per_row_mobile > 1 and section_st.items_per_row_mobile < 2
    assign data_free_scroll = 'true'
  endif
  assign show_arrow = section_st.show_arrow
  assign carousel_pagination = section_st.carousel_pagination
  assign infinite = section_st.infinite
  assign autoplay = section_st.autoplay
  assign autorotate_speed = section_st.autorotate_speed
  assign reveal = section_st.reveal
  assign scroll_animation = settings.scroll_animation
  assign animate_delay = 0

  # Get current product's model number
  assign current_model_no = product.metafields.global.product_additional_modelno
  assign has_matching_products = false
  assign matching_products_count = 0
  
  # Build array of matching product IDs with detailed debugging
  assign matching_product_ids = ''
  assign debug_loop_info = ''
  assign total_products_checked = 0
  assign products_with_model_numbers = 0
  
  if current_model_no != blank
    # Use search to find products with specific metafield values
    # This bypasses the 50-product limit
    assign search_query = 'metafields.global.product_additional_modelno:' | append: current_model_no
    assign search_results = search.results | where: 'object_type', 'product'
    
    # Also check through multiple collections to find all products
    assign all_collections_to_check = 'all,garcon-3-18-ans,sous-vetements-et-nuit,flanelles'
    assign collections_array = all_collections_to_check | split: ','
    
    for collection_handle in collections_array
      assign current_collection = collections[collection_handle]
      if current_collection != blank
        for check_product in current_collection.products
          assign total_products_checked = total_products_checked | plus: 1
          assign check_model = check_product.metafields.global.product_additional_modelno
      
      # Count products with any model number
      if check_model != blank
        assign products_with_model_numbers = products_with_model_numbers | plus: 1
      endif
      
      # Debug specific products we're looking for
      if check_product.title contains 'TEE-SHIRTS MANCHES LONGUES BLANCS' or check_product.title contains 'DEBARDEURS RAYES'
        assign debug_loop_info = debug_loop_info | append: 'FOUND TARGET: ' | append: check_product.title | append: ' - Model: "' | append: check_model | append: '" | '
      endif
      
      # Check for match
      if check_model == current_model_no and check_product.id != product.id
        assign has_matching_products = true
        assign matching_products_count = matching_products_count | plus: 1
        
        # Store product ID for later use
        if matching_product_ids == blank
          assign matching_product_ids = check_product.id | append: ''
        else
          assign matching_product_ids = matching_product_ids | append: ',' | append: check_product.id
        endif
        
        # Add to debug info
        assign debug_loop_info = debug_loop_info | append: 'MATCH FOUND: ' | append: check_product.title | append: ' | '
        
          # Stop after finding the number we want to show
          if matching_products_count >= items_to_show
            break
          endif
        endif
      endfor
      endif
    endfor
  endif
-%}

<!-- COMPREHENSIVE DEBUG OUTPUT -->
<div style="background: #f0f0f0; padding: 15px; margin: 15px; border: 2px solid #ccc; font-family: monospace;">
  <h3 style="margin: 0 0 10px 0; color: #333;">üîç Complete the Look - Debug Information</h3>
  
  <div style="background: #fff; padding: 10px; margin: 5px 0; border-left: 4px solid #007cba;">
    <strong>Current Product Info:</strong><br>
    ‚Ä¢ Product ID: {{ product.id }}<br>
    ‚Ä¢ Product Title: {{ product.title }}<br>
    ‚Ä¢ Model Number: "{{ current_model_no }}" ({{ current_model_no | size }} characters)<br>
  </div>
  
  <div style="background: #fff; padding: 10px; margin: 5px 0; border-left: 4px solid #28a745;">
    <strong>Search Results:</strong><br>
    ‚Ä¢ Total Products Checked: {{ total_products_checked }}<br>
    ‚Ä¢ Products with Model Numbers: {{ products_with_model_numbers }}<br>
    ‚Ä¢ Has Matching Products: {{ has_matching_products }}<br>
    ‚Ä¢ Matching Products Count: {{ matching_products_count }}<br>
    ‚Ä¢ Matching Product IDs: {{ matching_product_ids }}<br>
    ‚Ä¢ Debug Loop Info: {{ debug_loop_info }}<br>
  </div>
  
  <div style="background: #fff; padding: 10px; margin: 5px 0; border-left: 4px solid #dc3545;">
    <strong>Collection Analysis:</strong><br>
    ‚Ä¢ Collections.all size: {{ collections.all.products.size }}<br>
    ‚Ä¢ Current product collections: 
    {% for collection in product.collections limit: 5 %}
      {{ collection.title }}{% unless forloop.last %}, {% endunless %}
    {% endfor %}<br>
  </div>
  
  <div style="background: #fff; padding: 10px; margin: 5px 0; border-left: 4px solid #ffc107;">
    <strong>Products with Model "{{ current_model_no }}" (All Collections Search):</strong><br>
    {% assign found_count = 0 %}
    {% assign collections_to_check = 'all,garcon-3-18-ans,sous-vetements-et-nuit,flanelles,anoraks,blousons,bebe-garcon-6-24-mois,cires' %}
    {% assign collections_array = collections_to_check | split: ',' %}
    
    {% for collection_handle in collections_array %}
      {% assign current_collection = collections[collection_handle] %}
      {% if current_collection != blank %}
        {% for debug_product in current_collection.products %}
          {% assign debug_model = debug_product.metafields.global.product_additional_modelno %}
          {% if debug_model == current_model_no %}
            {% assign found_count = found_count | plus: 1 %}
            ‚Ä¢ {{ debug_product.title }} (ID: {{ debug_product.id }}) [{{ collection_handle }}]
            {% if debug_product.id == product.id %}<strong style="color: red;"> ‚Üê CURRENT PRODUCT</strong>{% endif %}
            <br>
          {% endif %}
        {% endfor %}
      {% endif %}
    {% endfor %}
    Total found across all collections: {{ found_count }}
  </div>
  
  <div style="background: #fff; padding: 10px; margin: 5px 0; border-left: 4px solid #fd7e14;">
    <strong>Live Match Test for "{{ current_model_no }}":</strong><br>
    {% assign live_match_count = 0 %}
    {% assign collections_array = collections_to_check | split: ',' %}
    
    {% for collection_handle in collections_array %}
      {% assign current_collection = collections[collection_handle] %}
      {% if current_collection != blank %}
        {% for test_product in current_collection.products %}
          {% assign test_model = test_product.metafields.global.product_additional_modelno %}
          {% if test_model == current_model_no and test_product.id != product.id %}
            {% assign live_match_count = live_match_count | plus: 1 %}
            ‚Ä¢ MATCH: {{ test_product.title }} (ID: {{ test_product.id }})<br>
          {% endif %}
        {% endfor %}
      {% endif %}
    {% endfor %}
    Live matches (excluding current): {{ live_match_count }}
    <br><strong>Should show section:</strong> 
    {% if current_model_no != blank and live_match_count > 0 %}
      <span style="color: green; font-weight: bold;">YES ‚úì</span>
    {% else %}
      <span style="color: red; font-weight: bold;">NO ‚úó</span>
      {% if current_model_no == blank %} (No model number){% endif %}
      {% if current_model_no != blank and live_match_count == 0 %} (No matches found){% endif %}
    {% endif %}
  </div>
  
  <div style="background: #fff; padding: 10px; margin: 5px 0; border-left: 4px solid #6f42c1;">
    <strong>Specific Product Check (TEE-SHIRTS & DEBARDEURS):</strong><br>
    {% for debug_product in collections.all.products limit: 1000 %}
      {% if debug_product.title contains 'TEE-SHIRTS MANCHES LONGUES BLANCS' or debug_product.title contains 'DEBARDEURS RAYES' %}
        {% assign debug_model = debug_product.metafields.global.product_additional_modelno %}
        ‚Ä¢ {{ debug_product.title }} (ID: {{ debug_product.id }})<br>
        &nbsp;&nbsp;Model: "{{ debug_model }}" ({{ debug_model | size }} chars)<br>
        &nbsp;&nbsp;Match test: "{{ debug_model }}" == "{{ current_model_no }}" = 
        {% if debug_model == current_model_no %}
          <strong style="color: green;">TRUE</strong>
        {% else %}
          <strong style="color: red;">FALSE</strong>
        {% endif %}<br>
        &nbsp;&nbsp;Not current product: {{ debug_product.id }} != {{ product.id }} = 
        {% if debug_product.id != product.id %}
          <strong style="color: green;">TRUE</strong>
        {% else %}
          <strong style="color: red;">FALSE (this IS current product)</strong>
        {% endif %}<br><br>
      {% endif %}
    {% endfor %}
  </div>
  
  <div style="background: #fff; padding: 10px; margin: 5px 0; border-left: 4px solid #17a2b8;">
    <strong>Sample Products with ANY Model Numbers:</strong><br>
    {% assign sample_count = 0 %}
    {% for debug_product in collections.all.products limit: 200 %}
      {% assign debug_model = debug_product.metafields.global.product_additional_modelno %}
      {% if debug_model != blank %}
        {% assign sample_count = sample_count | plus: 1 %}
        ‚Ä¢ {{ debug_product.title }} - Model: "{{ debug_model }}"<br>
        {% if sample_count >= 10 %}{% break %}{% endif %}
      {% endif %}
    {% endfor %}
    Showing first 10 products with model numbers.
  </div>
</div>
<!-- END DEBUG -->

{%- if current_model_no != blank and has_matching_products -%}
  {%- capture style -%}
      --section-pt: {{ section_st.padding_top }}; --section-pb: {{ section_st.padding_bottom }};
    {%- endcapture -%}
  {%- capture col_style -%}
    {% if column_gap < 15 %}--col-gap: {{ column_gap }}px;{% else %}--col-gap: 15px;--col-gap-desktop: {{  column_gap }}px;{% endif %}
    {%- endcapture -%}
  <div
    class="section{% if section_st.padding_top < 30 %} pt-min{% endif %}{% if section_st.padding_bottom < 30 %} pb-min{% endif %} sec__related-product color-{{ color_scheme }} gradient{{ reset_spacing }}{% if reveal %} overflow-hidden{% endif %}"
    style="{{ style | strip | strip_newlines }}"
  >
    <div class="{{ section_width }}">
      {%- if heading != blank or description != blank -%}
        <div class="section__header mb-33 mb-sm-20 text-{{ section_st.header_alignment }}{% if section_st.section_width == 'full_width' %} px-20{% endif %}">
          {%- if heading != blank or description != blank -%}
            <div class="secion__header-inner">
              {%- if section_st.heading != blank -%}
                <motion-element
                  data-motion="{{ scroll_animation }}"
                  {% if scroll_animation == 'none' %}
                    hold
                  {% endif %}
                  data-motion-delay="{{ animate_delay }}"
                  class="block"
                >
                  <h2
                    class="section__header-heading heading-letter-spacing {{ header_size  }} mt-0{% if section_st.description != blank %} mb-10{% else %} mb-0{% endif %}"
                  >
                    {{ section.settings.heading }}
                  </h2>
                </motion-element>
              {% endif %}
              {%- if section_st.description != blank -%}
                {% assign animate_delay = animate_delay | plus: 50 %}
                <motion-element
                  data-motion="{{ scroll_animation }}"
                  data-motion-delay="{{ animate_delay }}"
                  {% if scroll_animation == 'none' %}
                    hold
                  {% endif %}
                  class="section__header-des block rich__text-m0"
                >
                  {{ section.settings.description }}
                </motion-element>
              {% endif %}
            </div>
          {% endif %}
        </div>
      {% endif %}
      {% if section_st.items_per_row_mobile > 1 and section_st.items_per_row_mobile < 2 %}
        <div class="free-scroll">
      {% endif %}
      <div
        data-section-id="{{ section.id }}"
        data-autoplay="{{ autoplay }}"
        data-effect="slide"
        data-loop="{{ infinite }}"
        data-speed="500"
        data-autoplay-speed="{{ autorotate_speed }}"
        data-spacing="{{ column_gap }}"
        data-mobile="{{ section_st.items_per_row_mobile }}"
        data-desktop="{{ items_per_row }}"
        data-free-scroll="{{ data_free_scroll }}"
        data-pagination-progressbar="{% if carousel_pagination == 'show_progress_bar' %}true{% else %}false{% endif %}"
        style="{{ col_style | strip | strip_newlines }}"
        class="swiper products-complete-look page-width section-{{ section.id }}-padding isolate"
        data-arrow-centerimage="1"
      >
        {% if show_arrow %}
          {%- render 'swiper-navigation' -%}
        {% endif %}
        <div class="swiper-wrapper">
          {% comment %} Loop through multiple collections to find and display matching products {% endcomment %}
          {% assign displayed_count = 0 %}
          {% assign collections_to_check = 'all,garcon-3-18-ans,sous-vetements-et-nuit,flanelles' %}
          {% assign collections_array = collections_to_check | split: ',' %}
          
          {% for collection_handle in collections_array %}
            {% assign current_collection = collections[collection_handle] %}
            {% if current_collection != blank %}
              {% for item in current_collection.products %}
                {% assign item_model = item.metafields.global.product_additional_modelno %}
                
                {% if item_model == current_model_no and item.id != product.id %}
                  {% render 'product-item',
                    card_product: item,
                    section_id: section.id,
                    class: ' swiper-slide',
                    template_enable_action: true,
                    template_enable_product_vendor: true,
                    template_enable_rate: true,
                    template_enable_product_short_description: false,
                    template_enable_color_swatches: true,
                    template_enable_price: true,
                    template_enable_product_badges: true,
                    template_enable_add_cart: true,
                    scroll_animation: scroll_animation,
                    indexFor: forloop.index
                  %}
                  {% assign displayed_count = displayed_count | plus: 1 %}
                  {% if displayed_count >= items_to_show %}
                    {% break %}
                  {% endif %}
                {% endif %}
              {% endfor %}
            {% endif %}
            {% if displayed_count >= items_to_show %}
              {% break %}
            {% endif %}
          {% endfor %}
        </div>
        {%- if carousel_pagination == 'show_dots'
          or carousel_pagination == 'show_dots_on_mobile'
          or carousel_pagination == 'show_progress_bar'
        -%}
          <div
            class="swiper-pagination flex flex-wrap px-15 lh-1 bottom-30 {% if carousel_pagination == 'show_dots_on_mobile' %} hidden-md{% endif %} justify-content-center{% if section_st.content_below_image %} absolute-md-impo{% endif %}"
            style="--swiper-pagination-bottom: 3rem;--swiper-pagination-position: static;"
          ></div>
        {% endif %}
      </div>
      {% if section_st.items_per_row_mobile > 1 and section_st.items_per_row_mobile < 2 %}</div>{% endif %}
    </div>
  </div>
{%- endif -%}

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize swiper for complete-look section
  const completeLoookSwipers = document.querySelectorAll('.products-complete-look.swiper');
  
  completeLoookSwipers.forEach(function(swiperEl) {
    if (swiperEl.swiper) return; // Already initialized
    
    const swiperConfig = {
      slidesPerView: 1,
      spaceBetween: parseInt(swiperEl.dataset.spacing) || 30,
      speed: parseInt(swiperEl.dataset.speed) || 500,
      loop: swiperEl.dataset.loop === 'true',
      autoplay: swiperEl.dataset.autoplay === 'true' ? {
        delay: (parseInt(swiperEl.dataset.autoplaySpeed) || 5) * 1000,
        disableOnInteraction: false,
      } : false,
      breakpoints: {
        768: {
          slidesPerView: parseInt(swiperEl.dataset.desktop) || 4,
        },
        480: {
          slidesPerView: parseFloat(swiperEl.dataset.mobile) || 1,
        }
      },
      navigation: {
        nextEl: swiperEl.querySelector('.swiper-button-next'),
        prevEl: swiperEl.querySelector('.swiper-button-prev'),
      },
      pagination: {
        el: swiperEl.querySelector('.swiper-pagination'),
        clickable: true,
        type: swiperEl.dataset.paginationProgressbar === 'true' ? 'progressbar' : 'bullets',
      },
    };
    
    // Initialize Swiper
    new Swiper(swiperEl, swiperConfig);
  });
});
</script>

{% schema %}
{
  "name": "Complete the Look",
  "tag": "section",
  "disabled_on": {
    "groups": ["header", "footer", "custom.overlay"]
  },
  "settings": [
    {
      "type": "select",
      "id": "section_width",
      "label": "t:sections.all.section_width.label",
      "default": "fluid_container",
      "options": [
        {
          "value": "container",
          "label": "t:sections.all.section_width.container.label"
        },
        {
          "value": "fluid_container",
          "label": "t:sections.all.section_width.fluid_container.label"
        },
        {
          "value": "stretch_width",
          "label": "t:sections.all.section_width.stretch_width.label"
        },
        {
          "value": "full_width",
          "label": "t:sections.all.section_width.full_width.label"
        }
      ]
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:sections.all.color_scheme.label",
      "default": "scheme-1"
    },
    {
      "type": "header",
      "content": "t:sections.all.section_header.label"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "t:sections.all.section_header.heading.label",
      "default": "Complete the Look"
    },
    {
      "type": "inline_richtext",
      "id": "description",
      "label": "t:sections.all.section_header.description.label"
    },
    {
      "type": "select",
      "id": "header_size",
      "label": "t:sections.all.section_header.header_size.label",
      "default": "medium",
      "options": [
        {
          "value": "small",
          "label": "t:sections.all.section_header.header_size.small.label"
        },
        {
          "value": "medium",
          "label": "t:sections.all.section_header.header_size.medium.label"
        },
        {
          "value": "large",
          "label": "t:sections.all.section_header.header_size.large.label"
        }
      ]
    },
    {
      "type": "select",
      "id": "header_alignment",
      "label": "t:sections.all.section_header.alignment.label",
      "default": "left",
      "options": [
        {
          "value": "left",
          "label": "t:sections.all.section_header.alignment.left.label"
        },
        {
          "value": "center",
          "label": "t:sections.all.section_header.alignment.center.label"
        },
        {
          "value": "right",
          "label": "t:sections.all.section_header.alignment.right.label"
        }
      ]
    },
    {
      "type": "header",
      "content": "Product Settings"
    },
    {
      "type": "range",
      "id": "items_to_show",
      "label": "t:sections.all.items.items_to_show.label",
      "min": 2,
      "max": 25,
      "step": 1,
      "default": 8
    },
    {
      "type": "range",
      "id": "items_per_row",
      "label": "t:sections.all.items.items_per_row.label",
      "min": 1,
      "max": 5,
      "step": 1,
      "default": 4
    },
    {
      "type": "range",
      "id": "column_gap",
      "label": "t:sections.all.items.column_gap.label",
      "min": 0,
      "max": 50,
      "step": 5,
      "default": 30,
      "unit": "px"
    },
    {
      "type": "header",
      "content": "t:sections.all.carousel_settings.label"
    },
    {
      "type": "checkbox",
      "id": "show_arrow",
      "label": "t:sections.all.carousel_settings.show-next-back.label",
      "default": false
    },
    {
      "type": "select",
      "id": "carousel_pagination",
      "label": "t:sections.all.carousel_settings.pagination.label",
      "options": [
        {
          "value": "disable",
          "label": "t:sections.all.carousel_settings.pagination.disable.label"
        },
        {
          "value": "show_dots",
          "label": "t:sections.all.carousel_settings.pagination.show_dots.label"
        },
        {
          "value": "show_dots_on_mobile",
          "label": "t:sections.all.carousel_settings.pagination.show_dots_on_mobile.label"
        },
        {
          "value": "show_progress_bar",
          "label": "t:sections.all.carousel_settings.pagination.show_progress_bar.label"
        }
      ]
    },
    {
      "type": "checkbox",
      "id": "infinite",
      "label": "t:sections.all.carousel_settings.infinite.label",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "autoplay",
      "label": "t:sections.all.carousel_settings.auto_change.label",
      "default": false
    },
    {
      "type": "range",
      "id": "autorotate_speed",
      "label": "t:sections.all.carousel_settings.change_slides_every.label",
      "max": 6,
      "min": 2,
      "step": 1,
      "unit": "s",
      "default": 5
    },
    {
      "type": "checkbox",
      "id": "reveal",
      "label": "t:sections.all.carousel_settings.reveal.label",
      "info": "t:sections.all.carousel_settings.reveal.info",
      "default": false
    },
    {
      "type": "header",
      "content": "t:sections.all.mobile_options.label"
    },
    {
      "type": "range",
      "id": "items_per_row_mobile",
      "label": "t:sections.all.items.items_per_row.label",
      "min": 1,
      "max": 2,
      "step": 0.5,
      "default": 1
    },
    {
      "type": "header",
      "content": "t:sections.all.section_padding.label"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "t:sections.all.section_padding.top.label",
      "default": 0,
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "t:sections.all.section_padding.bottom.label",
      "default": 0,
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px"
    },
    {
      "type": "checkbox",
      "id": "reset_spacing",
      "label": "t:sections.all.section_padding.reset_spacing.label",
      "default": false
    }
  ],
  "presets": [
    {
      "name": "Complete the Look",
      "category": "t:categories.product"
    }
  ]
}
{% endschema %}