{% liquid
  assign block_st = block.settings
  assign product = closest.product
  assign section_st = section.settings
  assign enable_skeleton_loading = section_st.enable_skeleton_loading
%}
<collapsible-block
  tabindex="0"
  {{ block.shopify_attributes }}
  class="bls-toggle {% if block_st.open == true %} active {% endif %} relative border-bottom block{% if enable_skeleton_loading %} skeleton-loading{% endif %}"
>
  <h3 class="h6 my-0 pointer py-17 relative collapsible-heading heading-letter-spacing">
    {{- block_st.heading }}
    <span class="open-children-toggle absolute inset-0 flex flex-end pointer">
      <span class="icon_plus-animation"> </span>
    </span>
  </h3>
  <div
    class="overflow-hidden {% if block_st.open == true %} open_collab {% endif %} collapsible-content"
    {% if block_st.open != true %}
      style="display: none;"
    {% endif %}
  >
    <div class="collapsible-content_inner mb-12 rich__text-mt-0{% if block_st.use_product_description == true %} product_description{% endif %}">
      {% if block_st.use_product_description == true %}
        {%- if product != blank -%}
          {{ product.description }}
          
          {%- comment -%} Add REF with variant metafield {%- endcomment -%}
          <div id="variant-ref-container" style="margin-top: 15px;">
            <strong>Ref</strong> <span id="variant-ref-value">{{ product.selected_or_first_available_variant.metafields.global.product_additional_erp_variantcode | default: 'N/A' }}</span> - <span id="variant-vendor-value">{{ product.selected_or_first_available_variant.metafields.global.product_additional_VendorItemNo | default: 'N/A' }}</span>
          </div>
        {%- else -%}
          {{ 'onboarding.default_description' | t }}
        {% endif %}
      {% else %}
        {{ block_st.content }}
        
        {%- comment -%} Add REF for custom content too {%- endcomment -%}
        <div id="variant-ref-container" style="margin-top: 15px;">
          <strong>REF</strong> <span id="variant-ref-value">{{ product.selected_or_first_available_variant.metafields.global.product_additional_erp_variantcode | default: 'N/A' }}</span> - <span id="variant-vendor-value">{{ product.selected_or_first_available_variant.metafields.global.product_additional_VendorItemNo | default: 'N/A' }}</span>
        </div>
      {% endif %}
    </div>
  </div>
</collapsible-block>

{%- comment -%} JavaScript to update REF value when variant changes {%- endcomment -%}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Function to update the REF value
  function updateVariantRef(variantId) {
    const refContainer = document.getElementById('variant-ref-value');
    const vendorContainer = document.getElementById('variant-vendor-value');
    if (!refContainer || !vendorContainer || !variantId) {
      console.log('REF Debug: Missing container or variant ID', {refContainer, vendorContainer, variantId});
      return;
    }
    
    console.log('REF Debug: Updating for variant ID:', variantId);
    
    // Try to get metafield from product JSON
    const productJson = document.querySelector('[data-product-json]');
    if (productJson) {
      try {
        const product = JSON.parse(productJson.textContent);
        const variant = product.variants.find(v => v.id == variantId);
        
        console.log('REF Debug: Found variant:', variant);
        console.log('REF Debug: Variant metafields:', variant ? variant.metafields : 'No variant found');
        console.log('REF Debug: Full variant object:', variant);
        
        if (variant) {
          // Try multiple possible metafield paths
          let erpCode = null;
          let vendorCode = null;
          
          // Check if metafields exist at all
          console.log('REF Debug: Variant has metafields?', variant.metafields ? 'Yes' : 'No');
          if (variant.metafields) {
            console.log('REF Debug: Available metafield namespaces:', Object.keys(variant.metafields));
          }
          
          // Method 1: Try different possible paths for ERP code
          if (variant.metafields?.global?.product_additional_erp_variantcode) {
            erpCode = variant.metafields.global.product_additional_erp_variantcode;
            console.log('REF Debug: Found ERP via global.product_additional_erp_variantcode:', erpCode);
          } else if (variant.metafields?.custom?.product_additional_erp_variantcode) {
            erpCode = variant.metafields.custom.product_additional_erp_variantcode;
            console.log('REF Debug: Found ERP via custom.product_additional_erp_variantcode:', erpCode);
          } else if (variant.metafields?.app?.product_additional_erp_variantcode) {
            erpCode = variant.metafields.app.product_additional_erp_variantcode;
            console.log('REF Debug: Found ERP via app.product_additional_erp_variantcode:', erpCode);
          } else if (variant.sku) {
            erpCode = variant.sku;
            console.log('REF Debug: Using SKU as ERP fallback:', erpCode);
          }
          
          // Method 2: Try different possible paths for VendorItemNo
          if (variant.metafields?.global?.product_additional_VendorItemNo) {
            vendorCode = variant.metafields.global.product_additional_VendorItemNo;
            console.log('REF Debug: Found Vendor via global.product_additional_VendorItemNo:', vendorCode);
          } else if (variant.metafields?.custom?.product_additional_VendorItemNo) {
            vendorCode = variant.metafields.custom.product_additional_VendorItemNo;
            console.log('REF Debug: Found Vendor via custom.product_additional_VendorItemNo:', vendorCode);
          } else if (variant.metafields?.app?.product_additional_VendorItemNo) {
            vendorCode = variant.metafields.app.product_additional_VendorItemNo;
            console.log('REF Debug: Found Vendor via app.product_additional_VendorItemNo:', vendorCode);
          }
          
          // Try alternative approaches - check if metafields are stored as strings or in different formats
          if (!erpCode && variant.metafields) {
            // Search through all metafield namespaces for anything containing 'erp' or 'variant'
            for (const [namespace, fields] of Object.entries(variant.metafields)) {
              console.log(`REF Debug: Checking namespace ${namespace}:`, fields);
              if (fields && typeof fields === 'object') {
                for (const [key, value] of Object.entries(fields)) {
                  console.log(`REF Debug: Field ${namespace}.${key}:`, value);
                  if (key.toLowerCase().includes('erp') || key.toLowerCase().includes('variant')) {
                    erpCode = value;
                    console.log(`REF Debug: Found ERP in ${namespace}.${key}:`, erpCode);
                    break;
                  }
                }
              }
              if (erpCode) break;
            }
          }
          
          if (!vendorCode && variant.metafields) {
            // Search for vendor-related metafields
            for (const [namespace, fields] of Object.entries(variant.metafields)) {
              if (fields && typeof fields === 'object') {
                for (const [key, value] of Object.entries(fields)) {
                  if (key.toLowerCase().includes('vendor') || key.toLowerCase().includes('item')) {
                    vendorCode = value;
                    console.log(`REF Debug: Found Vendor in ${namespace}.${key}:`, vendorCode);
                    break;
                  }
                }
              }
              if (vendorCode) break;
            }
          }
          
          // Update both containers
          if (erpCode) {
            refContainer.textContent = erpCode;
          } else {
            refContainer.textContent = 'N/A';
            console.log('REF Debug: No metafield or SKU found for variant');
          }
          
          if (vendorCode) {
            vendorContainer.textContent = vendorCode;
          } else {
            vendorContainer.textContent = 'N/A';
            console.log('REF Debug: No VendorItemNo found for variant');
          }
        } else {
          refContainer.textContent = 'N/A';
          vendorContainer.textContent = 'N/A';
          console.log('REF Debug: Variant not found in product JSON');
        }
      } catch (error) {
        console.log('REF Debug: Error parsing product JSON:', error);
        refContainer.textContent = 'Error';
        vendorContainer.textContent = 'Error';
      }
    } else {
      console.log('REF Debug: Product JSON not found');
      refContainer.textContent = 'No JSON';
      vendorContainer.textContent = 'No JSON';
    }
  }
  
  // Listen for variant changes
  document.addEventListener('change', function(e) {
    if (e.target.name === 'id' || e.target.classList.contains('product-sticky-js')) {
      updateVariantRef(e.target.value);
    }
  });
  
  // Also listen for any variant input changes
  document.addEventListener('input', function(e) {
    if (e.target.name === 'id') {
      updateVariantRef(e.target.value);
    }
  });
  
  // Get initial variant on page load
  setTimeout(() => {
    const initialInput = document.querySelector('input[name="id"]');
    if (initialInput && initialInput.value) {
      updateVariantRef(initialInput.value);
    }
  }, 500);
});
</script>
{% schema %}
{
  "name": "t:blocks.general.collapsible_row.name",
  "tag": null,
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "default": "Collapsible row",
      "label": "t:sections.main-product.blocks.collapsible_row.settings.heading"
    },
    {
      "type": "richtext",
      "id": "content",
      "label": "t:sections.main-product.blocks.collapsible_row.settings.content"
    },
    {
      "type": "checkbox",
      "id": "use_product_description",
      "default": false,
      "label": "t:sections.main-product.blocks.collapsible_row.settings.use_product_description"
    },
    {
      "type": "checkbox",
      "id": "open",
      "default": false,
      "label": "t:sections.main-product.blocks.collapsible_row.settings.open.label"
    }
  ],
  "presets": [
    {
      "name": "t:blocks.general.collapsible_row.name"
    }
  ]
}
{% endschema %}
