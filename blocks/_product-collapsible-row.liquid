{% liquid
  assign block_st = block.settings
  assign product = closest.product
  assign section_st = section.settings
  assign enable_skeleton_loading = section_st.enable_skeleton_loading
%}
<collapsible-block
  tabindex="0"
  {{ block.shopify_attributes }}
  class="bls-toggle {% if block_st.open == true %} active {% endif %} relative border-bottom block{% if enable_skeleton_loading %} skeleton-loading{% endif %}"
>
  <h3 class="h6 my-0 pointer py-17 relative collapsible-heading heading-letter-spacing">
    {{- block_st.heading }}
    <span class="open-children-toggle absolute inset-0 flex flex-end pointer">
      <span class="icon_plus-animation"> </span>
    </span>
  </h3>
  <div
    class="overflow-hidden {% if block_st.open == true %} open_collab {% endif %} collapsible-content"
    {% if block_st.open != true %}
      style="display: none;"
    {% endif %}
  >
    <div class="collapsible-content_inner mb-12 rich__text-mt-0{% if block_st.use_product_description == true %} product_description{% endif %}">
      <!-- DEBUG: Always show VendorItemNo -->
      <div style="background:#e0f7fa;color:#00796b;padding:6px 10px;font-size:12px;margin-bottom:4px;">
        <strong>DEBUG VendorItemNo:</strong>
        <code>{{ product.selected_or_first_available_variant.metafields.global.product_additional_VendorItemNo | default: 'N/A' }}</code>
      </div>
      {% if block_st.use_product_description == true %}
        {%- if product != blank -%}
          {{ product.description }}
          {%- if product.selected_or_first_available_variant != blank and product.selected_or_first_available_variant.metafields != blank -%}
            <div id="variant-ref-container" style="margin-top: 15px;">
              <strong>Ref</strong> <span id="variant-ref-value">{{ product.selected_or_first_available_variant.metafields.global.product_additional_VendorItemNo | default: 'N/A' }}</span>
            </div>
          {%- else -%}
            <div id="variant-ref-container" style="margin-top: 15px; color: #c00;">
              <strong>Ref</strong> <span id="variant-ref-value">N/A (variant/metafields missing)</span>
            </div>
          {%- endif -%}
        {%- else -%}
          {{ 'onboarding.default_description' | t }}
          <div id="variant-ref-container" style="margin-top: 15px; color: #c00;">
            <strong>Ref</strong> <span id="variant-ref-value">N/A (product missing)</span>
          </div>
        {% endif %}
      {% else %}
        {{ block_st.content }}
        {%- if product != blank and product.selected_or_first_available_variant != blank and product.selected_or_first_available_variant.metafields != blank -%}
          <div id="variant-ref-container" style="margin-top: 15px;">
            <strong>REF</strong> <span id="variant-ref-value">{{ product.selected_or_first_available_variant.metafields.global.product_additional_VendorItemNo | default: 'N/A' }}</span>
          </div>
        {%- else -%}
          <div id="variant-ref-container" style="margin-top: 15px; color: #c00;">
            <strong>REF</strong> <span id="variant-ref-value">N/A (product/variant/metafields missing)</span>
          </div>
        {%- endif -%}
      {% endif %}
    </div>
  </div>
</collapsible-block>

{%- comment -%} JavaScript to update REF value when variant changes {%- endcomment -%}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Function to update the REF value
  function updateVariantRef(variantId) {
    const refContainer = document.getElementById('variant-ref-value');
    if (!refContainer || !variantId) {
      console.log('REF Debug: Missing container or variant ID', {refContainer, variantId});
      return;
    }
    
    console.log('REF Debug: Updating for variant ID:', variantId);
    
    // Try to get metafield from product JSON
    const productJson = document.querySelector('[data-product-json]');
    if (productJson) {
      try {
        const product = JSON.parse(productJson.textContent);
        const variant = product.variants.find(v => v.id == variantId);
        
        console.log('REF Debug: Found variant:', variant);
        console.log('REF Debug: Variant metafields:', variant ? variant.metafields : 'No variant found');
        
        if (variant) {
          // Try multiple possible metafield paths
          let erpCode = null;
          
          // Method 1: global.product_additional_VendorItemNo
          if (variant.metafields && variant.metafields.global && variant.metafields.global.product_additional_VendorItemNo) {
            erpCode = variant.metafields.global.product_additional_VendorItemNo;
            console.log('REF Debug: Found via global.product_additional_VendorItemNo:', erpCode);
          }
          
          // Method 2: Try custom namespace
          else if (variant.metafields && variant.metafields.custom && variant.metafields.custom.product_additional_VendorItemNo) {
            erpCode = variant.metafields.custom.product_additional_VendorItemNo;
            console.log('REF Debug: Found via custom.product_additional_VendorItemNo:', erpCode);
          }
          
          // Method 3: Check variant SKU as fallback
          else if (variant.sku) {
            erpCode = variant.sku;
            console.log('REF Debug: Using SKU as fallback:', erpCode);
          }
          
          if (erpCode) {
            refContainer.textContent = erpCode;
          } else {
            refContainer.textContent = 'N/A';
            console.log('REF Debug: No metafield or SKU found for variant');
          }
        } else {
          refContainer.textContent = 'N/A';
          console.log('REF Debug: Variant not found in product JSON');
        }
      } catch (error) {
        console.log('REF Debug: Error parsing product JSON:', error);
        refContainer.textContent = 'Error';
      }
    } else {
      console.log('REF Debug: Product JSON not found');
      refContainer.textContent = 'No JSON';
    }
  }
  
  // Listen for variant changes
  document.addEventListener('change', function(e) {
    if (e.target.name === 'id' || e.target.classList.contains('product-sticky-js')) {
      updateVariantRef(e.target.value);
    }
  });
  
  // Also listen for any variant input changes
  document.addEventListener('input', function(e) {
    if (e.target.name === 'id') {
      updateVariantRef(e.target.value);
    }
  });
  
  // Get initial variant on page load
  setTimeout(() => {
    const initialInput = document.querySelector('input[name="id"]');
    if (initialInput && initialInput.value) {
      updateVariantRef(initialInput.value);
    }
  }, 500);
});
</script>
{% schema %}
{
  "name": "t:blocks.general.collapsible_row.name",
  "tag": null,
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "default": "Collapsible row",
      "label": "t:sections.main-product.blocks.collapsible_row.settings.heading"
    },
    {
      "type": "richtext",
      "id": "content",
      "label": "t:sections.main-product.blocks.collapsible_row.settings.content"
    },
    {
      "type": "checkbox",
      "id": "use_product_description",
      "default": false,
      "label": "t:sections.main-product.blocks.collapsible_row.settings.use_product_description"
    },
    {
      "type": "checkbox",
      "id": "open",
      "default": false,
      "label": "t:sections.main-product.blocks.collapsible_row.settings.open.label"
    }
  ],
  "presets": [
    {
      "name": "t:blocks.general.collapsible_row.name"
    }
  ]
}
{% endschema %}
