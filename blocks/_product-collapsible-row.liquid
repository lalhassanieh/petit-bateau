{% liquid
  assign block_st = block.settings
  assign product = closest.product
  assign section_st = section.settings
  assign enable_skeleton_loading = section_st.enable_skeleton_loading
%}
<collapsible-block
  tabindex="0"
  {{ block.shopify_attributes }}
  class="bls-toggle {% if block_st.open == true %} active {% endif %} relative border-bottom block{% if enable_skeleton_loading %} skeleton-loading{% endif %}"
>
  <h3 class="h6 my-0 pointer py-17 relative collapsible-heading heading-letter-spacing">
    {{- block_st.heading }}
    <span class="open-children-toggle absolute inset-0 flex flex-end pointer">
      <span class="icon_plus-animation"> </span>
    </span>
  </h3>
  <div
    class="overflow-hidden {% if block_st.open == true %} open_collab {% endif %} collapsible-content"
    {% if block_st.open != true %}
      style="display: none;"
    {% endif %}
  >
    <div class="collapsible-content_inner mb-12 rich__text-mt-0{% if block_st.use_product_description == true %} product_description{% endif %}">
      {% if block_st.use_product_description == true %}
        {%- if product != blank -%}
          {{ product.description }}
          
          {%- comment -%} Add REF with variant metafield {%- endcomment -%}
          <div id="variant-ref-container" style="margin-top: 15px;">
            <strong>Ref</strong> <span id="variant-vendor-value">{{ product.selected_or_first_available_variant.metafields.global.product_additional_VendorItemNo | default: 'N/A' }}</span>
          </div>
        {%- else -%}
          {{ 'onboarding.default_description' | t }}
        {% endif %}
      {% else %}
        {{ block_st.content }}
        
        {%- comment -%} Add REF for custom content too {%- endcomment -%}
        <div id="variant-ref-container" style="margin-top: 15px;">
          <strong>REF</strong> <span id="variant-vendor-value">{{ product.selected_or_first_available_variant.metafields.global.product_additional_VendorItemNo | default: 'N/A' }}</span>
        </div>
      {% endif %}
    </div>
  </div>
</collapsible-block>

{%- comment -%} JavaScript to update REF value when variant changes {%- endcomment -%}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Function to update the REF value
  function updateVariantRef(variantId) {
    const vendorContainer = document.getElementById('variant-vendor-value');
    if (!vendorContainer || !variantId) {
      return;
    }
    
    // Try to get metafield from product JSON
    const productJson = document.querySelector('[data-product-json]');
    if (productJson) {
      try {
        const product = JSON.parse(productJson.textContent);
        const variant = product.variants.find(v => v.id == variantId);
        
        if (variant) {
          // Try multiple possible metafield paths
          let vendorCode = null;
          
          // Try different possible paths for VendorItemNo
          if (variant.metafields?.global?.product_additional_VendorItemNo) {
            vendorCode = variant.metafields.global.product_additional_VendorItemNo;
          } else if (variant.metafields?.custom?.product_additional_VendorItemNo) {
            vendorCode = variant.metafields.custom.product_additional_VendorItemNo;
          } else if (variant.metafields?.app?.product_additional_VendorItemNo) {
            vendorCode = variant.metafields.app.product_additional_VendorItemNo;
          }
          
          if (!vendorCode && variant.metafields) {
            // Search for vendor-related metafields
            for (const [namespace, fields] of Object.entries(variant.metafields)) {
              if (fields && typeof fields === 'object') {
                for (const [key, value] of Object.entries(fields)) {
                  if (key.toLowerCase().includes('vendor') || key.toLowerCase().includes('item')) {
                    vendorCode = value;
                    break;
                  }
                }
              }
              if (vendorCode) break;
            }
          }
          
          // Update vendor container
          vendorContainer.textContent = vendorCode || 'N/A';
        } else {
          vendorContainer.textContent = 'N/A';
        }
      } catch (error) {
        vendorContainer.textContent = 'Error';
      }
    } else {
      vendorContainer.textContent = 'No JSON';
    }
  }
  
  // Listen for variant changes
  document.addEventListener('change', function(e) {
    if (e.target.name === 'id' || e.target.classList.contains('product-sticky-js')) {
      updateVariantRef(e.target.value);
    }
  });
  
  // Also listen for any variant input changes
  document.addEventListener('input', function(e) {
    if (e.target.name === 'id') {
      updateVariantRef(e.target.value);
    }
  });
  
  // Get initial variant on page load
  setTimeout(() => {
    const initialInput = document.querySelector('input[name="id"]');
    if (initialInput && initialInput.value) {
      updateVariantRef(initialInput.value);
    }
  }, 500);
});
</script>
{% schema %}
{
  "name": "t:blocks.general.collapsible_row.name",
  "tag": null,
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "default": "Collapsible row",
      "label": "t:sections.main-product.blocks.collapsible_row.settings.heading"
    },
    {
      "type": "richtext",
      "id": "content",
      "label": "t:sections.main-product.blocks.collapsible_row.settings.content"
    },
    {
      "type": "checkbox",
      "id": "use_product_description",
      "default": false,
      "label": "t:sections.main-product.blocks.collapsible_row.settings.use_product_description"
    },
    {
      "type": "checkbox",
      "id": "open",
      "default": false,
      "label": "t:sections.main-product.blocks.collapsible_row.settings.open.label"
    }
  ],
  "presets": [
    {
      "name": "t:blocks.general.collapsible_row.name"
    }
  ]
}
{% endschema %}
